<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="mail.Message" owl="1">
        <div class="o-Message"
            t-att-class="{
                'o-isClicked': state.isClicked,
                'o-isDiscussion': message and (message.$$$isDiscussion(mself) or message.$$$isNotification(mself)),
                'o-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself),
                'o-isNotDiscussion': message and !(message.$$$isDiscussion(mself) or message.$$$isNotification(mself)),
                'o-isNotification': message and message.$$$type(mself) === 'notification',
                'o-isSelected': isSelected,
                'o-isSquashed': isSquashed,
                'o-isStarred': message and message.$$$isStarred(mself),
            }" t-on-click="_onClick" t-att-data-message-local-id="message and message.localId"
        >
            <t t-if="message" name="rootCondition">
                <div class="o-Message-sidebar" t-att-class="{ 'o-isMessageSquashed': isSquashed }">
                    <t t-if="!isSquashed">
                        <div class="o-Message-authorAvatarContainer o-Message-sidebarItem">
                            <img class="o-Message-authorAvatar rounded-circle" t-att-class="{ o-Message-authorRedirect: hasAuthorOpenChat, o_redirect: hasAuthorOpenChat }" t-att-src="avatar" t-on-click="_onClickAuthorAvatar" t-att-title="hasAuthorOpenChat ? OPEN_CHAT : ''" alt="Avatar"/>
                            <t t-if="message.$$$author(mself) and message.$$$author(mself).$$$im_status(mself)">
                                <PartnerImStatusIcon
                                    class="o-Message-partnerImStatusIcon"
                                    t-att-class="{
                                        'o-isMessageNotDiscussion': !(message.$$$isDiscussion(mself) or message.$$$isNotification(mself)),
                                        'o-isMessageSelected': isSelected,
                                        'o-Message-partnerImStatusIcon-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself),
                                    }"
                                    hasOpenChat="hasAuthorOpenChat"
                                    partner="message.$$$author(mself)"
                                />
                            </t>
                        </div>
                    </t>
                    <t t-else="">
                        <div class="o-Message-date o-Message-sidebarItem o-isMessageSquashed" t-att-class="{ 'o-isMessageSelected': isSelected }">
                            <t t-esc="shortTime"/>
                        </div>
                        <div class="o-Message-commands o-Message-sidebarCommands o-Message-sidebarItem o-isMessageSquashed" t-att-class="{ 'o-isMessageSelected': isSelected, 'o-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself) }">
                            <t t-if="message.$$$type(mself) !== 'notification'">
                                <div class="o-Message-command o-Message-commandStar fa"
                                    t-att-class="{
                                        'fa-star': message.$$$isStarred(mself),
                                        'fa-star-o': !message.$$$isStarred(mself),
                                        'o-isMessageSelected': isSelected,
                                        'o-isMessageStarred': message.$$$isStarred(mself),
                                        'o-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself),
                                    }" t-on-click="_onClickStar"
                                />
                            </t>
                        </div>
                        <t t-if="message.$$$isCurrentPartnerAuthor(mself) and threadView and threadView.$$$thread(mself) and threadView.$$$thread(mself).$$$hasSeenIndicators(mself)">
                            <MessageSeenIndicator class="o-Message-seenIndicator o-isMessageSquashed" message="message" thread="threadView.$$$thread(mself)"/>
                        </t>
                    </t>
                </div>
                <div class="o-Message-core">
                    <t t-if="!isSquashed">
                        <div class="o-Message-header">
                            <t t-if="message.$$$author(mself)">
                                <div class="o-Message-authorName o-Message-authorRedirect o-hasRedirect" t-on-click="_onClickAuthorName" title="Open profile">
                                    <t t-esc="message.$$$author(mself).$$$nameOrDisplayName(mself)"/>
                                </div>
                            </t>
                            <t t-elif="message.$$$emailFrom(mself)">
                                <a class="o-Message-authorName" t-attf-href="mailto:{{ message.$$$emailFrom(mself) }}?subject=Re: {{ message.$$$subject(mself) ? message.$$$subject(mself) : '' }}">
                                    <t t-esc="message.$$$emailFrom(mself)"/>
                                </a>
                            </t>
                            <t t-else="">
                                <div class="o-Message-authorName">
                                    Anonymous
                                </div>
                            </t>
                            <div class="o-Message-date o-Message-headerDate" t-att-class="{ 'o-isMessageSelected': isSelected }" t-att-title="datetime">
                                - <t t-esc="message.$$$dateFromNow(mself)"/>
                            </div>
                            <t t-if="message.$$$isCurrentPartnerAuthor(mself) and threadView and threadView.$$$thread(mself)">
                                <MessageSeenIndicator class="o-Message-seenIndicator" message="message" thread="threadView.$$$thread(mself)"/>
                            </t>
                            <t t-if="threadView and message.$$$originThread(mself) and message.$$$originThread(mself) !== threadView.$$$thread(mself)">
                                <div class="o-Message-originThread" t-att-class="{ 'o-isMessageSelected': isSelected }">
                                    <t t-if="message.$$$originThread(mself).$$$model(mself) === 'mail.channel'">
                                        (from <a class="o-Message-originThreadLink" href="#" t-on-click="_onClickOriginThread">#<t t-esc="message.$$$originThread(mself).$$$name(mself)"/></a>)
                                    </t>
                                    <t t-else="">
                                        on <a class="o-Message-originThreadLink" href="#" t-on-click="_onClickOriginThread"><t t-esc="message.$$$originThread(mself).$$$name(mself)"/></a>
                                    </t>
                                </div>
                            </t>
                            <t t-if="message.$$$moderationStatus(mself) === 'pending_moderation' and !message.$$$isModeratedByCurrentPartner(mself)">
                                <span class="o-Message-moderationPending o-isCurrentPartnerAuthor" title="Your message is pending moderation.">Pending moderation</span>
                            </t>
                            <t t-if="threadView and message.$$$originThread(mself) and message.$$$originThread(mself) === threadView.$$$thread(mself) and message.$$$notifications(mself).length > 0">
                                <t t-if="message.$$$failureNotifications(mself).length > 0">
                                    <span class="o-Message-notificationIconClickable o-isError" t-on-click="_onClickFailure">
                                        <i name="failureIcon" class="o-Message-notificationIcon fa fa-envelope"/>
                                    </span>
                                </t>
                                <t t-else="">
                                    <Popover>
                                        <span class="o-Message-notificationIconClickable">
                                            <i name="notificationIcon" class="o-Message-notificationIcon fa fa-envelope-o"/>
                                        </span>
                                        <t t-set="opened">
                                            <NotificationPopover
                                                notifications="message.$$$notifications(mself)"
                                            />
                                        </t>
                                    </Popover>
                                </t>
                            </t>
                            <div class="o-Message-commands o-Message-headerCommands" t-att-class="{ 'o-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself) }">
                                <t t-if="!message.$$$isTemporary(mself) and ((message.$$$type(mself) !== 'notification' and message.$$$originThread(mself) and message.$$$originThread(mself).$$$model(mself) === 'mail.channel') or !message.$$$isTransient(mself)) and message.$$$moderationStatus(mself) !== 'pending_moderation'">
                                    <span class="o-Message-command o-Message-commandStar o-Message-headerCommand fa"
                                        t-att-class="{
                                            'fa-star': message.$$$isStarred(mself),
                                            'fa-star-o': !message.$$$isStarred(mself),
                                            'o-isMessageSelected': isSelected,
                                            'o-isMessageStarred': message.$$$isStarred(mself),
                                            'o-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself),
                                        }" t-on-click="_onClickStar" title="Mark as Todo"
                                    />
                                </t>
                                <t t-if="hasReplyIcon">
                                    <span class="o-Message-command o-Message-commandReply o-Message-headerCommand fa fa-reply"
                                        t-att-class="{
                                            'o-isMessageSelected': isSelected,
                                            'o-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself),
                                        }" t-on-click="_onClickReply" title="Reply"
                                    />
                                </t>
                                <t t-if="hasMarkAsReadIcon">
                                    <span class="o-Message-command o-Message-commandMarkAsRead o-Message-headerCommand fa fa-check"
                                        t-att-class="{
                                            'o-isMessageSelected': isSelected,
                                            'o-isMobile': env.messaging.$$$device(mself).$$$isMobile(mself),
                                        }" t-on-click="_onClickMarkAsRead" title="Mark as Read"
                                    />
                                </t>
                            </div>
                        </div>
                        <t t-if="message.$$$isModeratedByCurrentPartner(mself)">
                            <div class="o-Message-moderationSubHeader">
                                <t t-if="threadView and hasCheckbox and message.$$$hasCheckbox(mself)">
                                    <input class="o-Message-checkbox" type="checkbox" t-att-checked="message.isChecked(threadView.$$$thread(mself), threadView.$$$stringifiedDomain(mself)) ? 'checked': ''" t-on-change="_onChangeCheckbox" t-ref="checkbox"/>
                                </t>
                                <span class="o-Message-moderationPending">Pending moderation:</span>
                                <a class="o-Message-moderationAction o-accept" href="#" title="Accept" t-on-click="_onClickModerationAccept">Accept</a>
                                <a class="o-Message-moderationAction o-reject" href="#" title="Remove message with explanation" t-on-click="_onClickModerationReject">Reject</a>
                                <a class="o-Message-moderationAction o-discard" href="#" title="Remove message without explanation" t-on-click="_onClickModerationDiscard">Discard</a>
                                <a class="o-Message-moderationAction o-allow" href="#" title="Add this email address to white list of people" t-on-click="_onClickModerationAllow">Always Allow</a>
                                <a class="o-Message-moderationAction o-ban" href="#" title="Ban this email address" t-on-click="_onClickModerationBan">Ban</a>
                            </div>
                        </t>
                    </t>
                    <div class="o-Message-content" t-ref="content">
                        <t t-raw="message.$$$prettyBody(mself)"/>
                        <t t-if="message.$$$subtypeDescription(mself) and !message.$$$isBodyEqualSubtypeDescription(mself)">
                            <p t-esc="message.$$$subtypeDescription(mself)"/>
                        </t>
                        <t t-if="trackingValues.length > 0">
                            <ul class="o-Message-trackingValues">
                                <t t-foreach="trackingValues" t-as="value" t-key="value.id">
                                    <li>
                                        <div class="o-Message-trackingValue">
                                            <div class="o-Message-trackingValueFieldName o-Message-trackingValueItem" t-esc="value.changed_field"/>
                                            <div class="o-Message-trackingValueOldValue o-Message-trackingValueItem" t-esc="value.old_value"/>
                                            <t t-if="value.old_value !== value.new_value">
                                                <div class="o-Message-trackingValueSeparator o-Message-trackingValueItem fa fa-long-arrow-right" title="Changed" role="img"/>
                                                <div class="o-Message-trackingValueNewValue o-Message-trackingValueItem" t-esc="value.new_value"/>
                                            </t>
                                        </div>
                                    </li>
                                </t>
                            </ul>
                        </t>
                    </div>
                    <t t-if="message.$$$subject(mself) and threadView and threadView.$$$thread(mself) and (threadView.$$$thread(mself).$$$isMassMailing(mself) or [env.messaging.$$$inbox(mself), env.messaging.$$$history(mself)].includes(threadView.$$$thread(mself)))">
                        <p class="o-Message-subject">Subject: <t t-esc="message.$$$subject(mself)"/></p>
                    </t>
                    <t t-if="message.$$$attachments(mself) and message.$$$attachments(mself).length > 0">
                        <div class="o-Message-footer">
                            <!-- TODO XDU This does not allow to preview all attachments at once, find somethind else -->
                            <t t-if="imageAttachments and imageAttachments.length > 0">
                                <AttachmentList
                                    class="o-Message-attachmentList"
                                    areAttachmentsDownloadable="true"
                                    areAttachmentsEditable="message.$$$author(mself) === env.messaging.$$$currentPartner(mself)"
                                    attachments="imageAttachments"
                                    attachmentsDetailsMode="attachmentsDetailsMode"
                                />
                            </t>
                            <t t-if="nonImageAttachments and nonImageAttachments.length > 0">
                                <AttachmentList
                                    class="o-Message-attachmentList"
                                    areAttachmentsDownloadable="true"
                                    areAttachmentsEditable="message.$$$author(mself) === env.messaging.$$$currentPartner(mself)"
                                    attachments="nonImageAttachments"
                                    attachmentsDetailsMode="attachmentsDetailsMode"
                                />
                            </t>
                        </div>
                    </t>
                </div>
                <t t-if="state.hasModerationBanDialog">
                    <ModerationBanDialog messages="[message]" t-on-dialog-closed="_onDialogClosedModerationBan"/>
                </t>
                <t t-if="state.hasModerationDiscardDialog">
                    <ModerationDiscardDialog messages="[message]" t-on-dialog-closed="_onDialogClosedModerationDiscard"/>
                </t>
                <t t-if="state.hasModerationRejectDialog">
                    <ModerationRejectDialog messages="[message]" t-on-dialog-closed="_onDialogClosedModerationReject"/>
                </t>
            </t>
        </div>
    </t>

</templates>
