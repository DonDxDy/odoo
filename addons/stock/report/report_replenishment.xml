<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <!-- Reports -->
    <report
        id="stock_replenishment_report_product_product_action"
        string="Forecasted Inventory"
        model="product.product"
        report_type="qweb-html"
        name="stock.report_product_product_replenishment"
        file="stock.report_product_product_replenishment"/>

    <report
        id="stock_replenishment_report_product_template_action"
        string="Forecasted Inventory"
        model="product.template"
        report_type="qweb-html"
        name="stock.report_product_template_replenishment"
        file="stock.report_replenishment"/>

  <!-- Templates -->
    <template id="assets_common_replenishment_report" name="Forecasted Inventory CSS" inherit_id="web.report_assets_common">
        <xpath expr="." position="inside">
            <link rel="stylesheet" type="text/scss" href="/stock/static/src/scss/report_replenishment.scss"/>
        </xpath>
        <xpath expr="script" position="after">
            <script type="text/javascript" src="/stock/static/src/js/stock_replenish_report.js"/>
        </xpath>
    </template>

    <template id="report_product_product_replenishment">
        <t t-call="web.html_container">
            <div class="o_statusbar_buttons">
                <button class="btn btn-primary" title="test" name="test">Test</button>
            </div>
            <div js_class="stock_replenish_report" class="page pt-3">
                <div class="d-flex justify-content-between">
                    <div class="o_product_name">
                        <h3>
                            <t t-if="docs['product_templates']">
                                <t t-foreach="docs['product_templates']" t-as="product_template">
                                    <a href="#" res-model="product.template" view-type="form" t-att-res-id="product_template.id">
                                        <t t-esc="product_template.display_name"/>
                                    </a>
                                </t>
                            </t>
                            <t t-elif="docs['product_variants']">
                                <t t-foreach="docs['product_variants']" t-as="product_variant">
                                    <a href="#" res-model="product.product" view-type="form" t-att-res-id="product_variant.id">
                                        <t t-esc="product_variant.display_name"/>
                                    </a>
                                </t>
                            </t>
                        </h3>
                        <h6 t-if="docs['product_templates'] and docs['product_variants'] and len(docs['product_templates']) != len(docs['product_variants'])">
                            <t t-foreach="docs['product_variants']" t-as="product_variant">
                                <a href="#" res-model="product.product" view-type="form" t-att-res-id="product_variant.id">
                                    <t t-esc="'[%s]' % product_variant.product_template_attribute_value_ids._get_combination_name()"/>
                                </a>
                            </t>
                        </h6>
                    </div>
                    <div class="row">
                        <div class="mx-3 text-center">
                            <div class="h3">
                                <t t-esc="docs['quantity_on_hand']"/>
                                <t t-esc="docs['uom']" groups="uom.group_uom"/>
                            </div>
                            <div>On Hand</div>
                        </div>
                        <div t-attf-class="mx-3 text-center #{docs['virtual_available'] &lt; 0 and 'text-danger'}">
                            <div class="h3">
                                <t t-esc="docs['virtual_available']"/>
                                <t t-esc="docs['uom']" groups="uom.group_uom"/>
                            </div>
                            <div>Forcasted</div>
                        </div>
                        <t t-set="future_virtual_available" t-value="docs['virtual_available'] + docs['qty']['in'] - docs['qty']['out']"/>
                        <div name="pending_forecasted" t-attf-class="mx-3 text-center #{future_virtual_available &lt; 0 and 'text-danger'}">
                            <div class="h3">
                                <t t-esc="future_virtual_available"/>
                                <t t-esc="docs['uom']" groups="uom.group_uom"/>
                            </div>
                            <div>Forecasted<br/>+ Pending</div>
                        </div>
                    </div>
                </div>
                <table class="o_report_replenishment table table-bordered">
                    <thead>
                        <tr class="bg-light">
                            <td>Replenishment</td>
                            <td>Expected</td>
                            <td t-if="docs['multiple_product']">Product</td>
                            <td>Quantity</td>
                            <td groups="uom.group_uom">UoM</td>
                            <td>Used by</td>
                            <td>Expected Delivery</td>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="docs['lines']" t-as="line"><tr>
                            <td t-attf-class="#{line['is_late'] and 'o_grid_warning'}">
                                <a t-if="line['document_in']"
                                    t-attf-href="#" t-esc="line['document_in'].name"
                                    class="font-weight-bold" view-type="form"
                                    t-att-res-model="line['document_in']._name"
                                    t-att-res-id="line['document_in'].id"/>
                                <t t-elif="line['replenishment_filled']" t-esc="'Current Stock'"/>
                                <span t-else="" class="text-muted" t-esc="'not available'"/>
                            </td>
                            <td t-esc="line['receipt_date']"
                                t-attf-class="#{line['is_late'] and 'o_grid_warning'}"/>
                            <td t-if="docs['multiple_product']" t-esc="line['product']['display_name']"/>
                            <td t-esc="line['quantity']"/>
                            <td t-esc="line['uom_id'].name" groups="uom.group_uom"/>
                            <td t-attf-class="#{not line['replenishment_filled'] and 'o_grid_warning'}">
                                <a t-if="line['document_out']"
                                    t-attf-href="#" t-esc="line['document_out'].name"
                                    class="font-weight-bold" view-type="form"
                                    t-att-res-model="line['document_out']._name"
                                    t-att-res-id="line['document_out'].id"/>
                            </td>
                            <td t-esc="line['delivery_date']"
                                t-attf-class="#{not line['replenishment_filled'] and 'o_grid_warning'}"/>
                        </tr></t>
                    </tbody>
                </table>
                <table class="o_report_replenishment_summary table-sm table-bordered">
                    <thead>
                        <tr class="o_forecasted_row">
                            <td>Forecasted Inventory</td>
                            <td t-esc="docs['virtual_available']"/>
                            <td t-esc="docs['uom']" groups="uom.group_uom"/>
                        </tr>
                        <tr t-if="docs['qty']['in']" class="bg-light">
                            <td>Pending Incoming Document</td>
                            <td t-esc="docs['qty']['in']"/>
                            <td t-esc="docs['uom']"  groups="uom.group_uom"/>
                        </tr>
                    </thead>
                    <tbody t-if="docs['qty']['in']">
                        <tr t-if="docs['draft_picking_qty']['in']" name="draft_picking_in">
                            <td>Draft Transfer</td>
                            <td t-esc="docs['draft_picking_qty']['in']"/>
                            <td t-esc="docs['uom']" groups="uom.group_uom"/>
                        </tr>
                    </tbody>
                    <thead t-if="docs['qty']['out']">
                        <tr class="bg-light">
                            <td>Pendint Outgoing Document</td>
                            <td t-esc="docs['qty']['out']"/>
                            <td t-esc="docs['uom']"  groups="uom.group_uom"/>
                        </tr>
                    </thead>
                    <tbody t-if="docs['qty']['out']">
                        <tr t-if="docs['draft_picking_qty']['out']" name="draft_picking_out">
                            <td>Draft Transfer</td>
                            <td t-esc="docs['draft_picking_qty']['out']"/>
                            <td t-esc="docs['uom']" groups="uom.group_uom"/>
                        </tr>
                    </tbody>
                    <thead>
                        <tr class="o_forecasted_row">
                            <td>Forecasted with Pending</td>
                            <td t-esc="future_virtual_available"/>
                            <td t-esc="docs['uom']" groups="uom.group_uom"/>
                        </tr>
                    </thead>
                </table>
            </div>
        </t>
    </template>

    <template id="report_product_template_replenishment">
        <t t-call="stock.report_product_product_replenishment"/>
    </template>
</odoo>
