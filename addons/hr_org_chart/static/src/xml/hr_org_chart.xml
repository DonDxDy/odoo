<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

<!-- Note: Need to create EmployeeChart subcomponent as this template renders Popover
so main component should wait to finish mounting of all subcomponents, so here
we need to create EmployeeChart as subcomponent to properly render main component -->
<t t-name="hr_org_chart_employee" owl="1">
    <t t-set="employee" t-value="props.employee"/>
    <div t-attf-class="o_org_chart_entry o_org_chart_entry_{{props.employee_type}} media">
        <t t-set="is_self" t-value="employee.id == props.view_employee_id"/>

        <div class="o_media_left">
            <!-- NOTE: Since by the default on not squared images odoo add white borders,
                use bg-images to get a clean and centred images -->
            <a t-if="!is_self"
                class="o_media_object rounded-circle o_employee_redirect"
                t-on-click.prevent="_onEmployeeRedirect"
                t-att-style="'background-image:url(\'/web/image/hr.employee.public/' + employee.id + '/image_1024/\')'"
                t-att-alt="employee.name"
                t-att-data-employee-id="employee.id"
                t-att-href="employee.link"/>
            <div t-if="is_self"
                class="o_media_object rounded-circle"
                t-att-style="'background-image:url(\'/web/image/hr.employee.public/' + employee.id + '/image_1024/\')'"/>
        </div>

        <div class="media-body">
            <t t-if="employee.indirect_sub_count &gt; 0">
                <Popover position="'left'">
                    <t t-set-slot="opened">
                        <t t-call="hr_orgchart_emp_popover"/>
                    </t>
                    <span
                        class="badge badge-pill"
                        tabindex="0"
                        t-att-data-emp-name="employee.name"
                        t-att-data-emp-id="employee.id"
                        t-att-data-emp-dir-subs="employee.direct_sub_count"
                        t-att-data-emp-ind-subs="employee.indirect_sub_count">
                        <t t-esc="employee.indirect_sub_count"/>
                    </span>
                </Popover>
            </t>
            <t t-if="!is_self">
                <a t-att-href="employee.link"
                    class="o_employee_redirect"
                    t-on-click.prevent="_onEmployeeRedirect"
                    t-att-data-employee-id="employee.id">
                    <h5 class="o_media_heading"><b><t t-esc="employee.name"/></b></h5>
                    <strong><t t-esc="employee.job_title"/></strong>
                </a>
            </t>
            <t t-if="is_self">
                <h5 class="o_media_heading"><b><t t-esc="employee.name"/></b></h5>
                <strong><t t-esc="employee.job_title"/></strong>
            </t>
        </div>
    </div>
</t>

<div t-name="hr_org_chart" owl="1">
    <!-- NOTE: Desidered behaviour:
            The maximun number of people is always 7 (including 'self'). Managers have priority over suburdinates
            Eg. 1 Manager + 1 self = show just 5 subordinates (if availables)
            Eg. 0 Manager + 1 self = show 6 subordinates (if available)

        -->
    <t t-set="emp_count" t-value="0"/>

    <div t-if='orgData.managers.length &gt; 0' class="o_org_chart_group_up">
        <t t-if='orgData.managers_more'>
            <div class="o_org_chart_entry o_org_chart_more media">
                <div class="o_media_left">
                    <a class="text-center o_employee_more_managers"
                        t-on-click.prevent="_onEmployeeMoreManager"
                        t-att-data-employee-id="orgData.managers[0].id">
                        <i class="fa fa-angle-double-up" role="img" aria-label="More managers" title="More managers"/>
                    </a>
                </div>
            </div>
        </t>

        <t t-foreach="orgData.managers" t-as="employee" t-key="emp_count">
            <t t-set="emp_count" t-value="emp_count + 1"/>
            <EmployeeChart employee_type="'manager'" employee="employee" view_employee_id="orgData.view_employee_id"/>
        </t>
    </div>

    <t t-if="orgData.children.length || orgData.managers.length">
        <EmployeeChart employee_type="'self'" employee="orgData.self" view_employee_id="orgData.view_employee_id"/>
    </t>

    <t t-if="!orgData.children.length &amp;&amp; !orgData.managers.length">
        <div class="alert alert-info" role="alert">
            <p><b>No hierarchy position.</b></p>
            <p>This employee has no manager or subordinate.</p>
            <p>In order to get an organigram, set a manager and save the record.</p>
        </div>
    </t>

    <div t-if="orgData.children.length" class="o_org_chart_group_down">
        <t t-foreach="orgData.children" t-as="employee" t-key="employee.id">
            <t t-set="emp_count" t-value="emp_count + 1"/>
            <t t-if="emp_count &lt; 20">
                <EmployeeChart employee_type="'sub'" employee="employee" view_employee_id="orgData.view_employee_id"/>
            </t>
        </t>

        <t t-if="(orgData.children.length + orgData.managers.length) &gt; 19">
            <div class="o_org_chart_entry o_org_chart_more media">
                <div class="o_media_left">
                    <a href="#"
                        t-att-data-employee-id="orgData.self.id"
                        t-att-data-employee-name="orgData.self.name"
                        class="o_org_chart_show_more text-center o_employee_sub_redirect"
                        t-on-click.prevent="_onEmployeeSubRedirect">&#8230;</a>
                </div>
            </div>
        </t>
    </div>
</div>

<t t-name="hr_orgchart_emp_popover" owl="1">
    <div class="popover o_org_chart_popup">
        <h3 class="popover-header"><t t-call="hr_orgchart_emp_popover_title"/></h3>
        <div class="popover-content"><t t-call="hr_orgchart_emp_popover_content"/></div>
    </div>
</t>

<t t-name="hr_orgchart_emp_popover_content" owl="1">
    <div class="o_org_chart_content">
        <div>
            <span class="text-right" t-esc="employee.direct_sub_count"></span>
            <a href="#" class="o_employee_sub_redirect" data-type='direct'
                t-on-click.prevent="_onEmployeeSubRedirect"
                t-att-data-employee-name="employee.name"
                t-att-data-employee-id="employee.id">
                <b>Direct subordinates</b>
            </a>
        </div>
        <div>
            <span class="text-right" t-esc="employee.indirect_sub_count - employee.direct_sub_count"></span>
            <a href="#" class="o_employee_sub_redirect" data-type='indirect'
                t-on-click.prevent="_onEmployeeSubRedirect"
                t-att-data-employee-name="employee.name"
                t-att-data-employee-id="employee.id">
                Indirect subordinates
            </a>
        </div>
        <div>
            <span class="text-right" t-esc="employee.indirect_sub_count"></span>
            <a href="#" class="o_employee_sub_redirect" data-type='total'
                t-on-click.prevent="_onEmployeeSubRedirect"
                t-att-data-employee-name="employee.name"
                t-att-data-employee-id="employee.id">
                Total
            </a>
        </div>
    </div>
</t>

<t t-name="hr_orgchart_emp_popover_title" owl="1">
    <div>
        <span t-att-style='"background-image:url(\"/web/image/hr.employee.public/" + employee.id + "/image_1024/\")"' class="popover_title"/>
        <b><t t-esc="employee.name"/></b>
        <a href="#" class="float-right o_employee_redirect" t-on-click.prevent="_onEmployeeRedirect" t-att-data-employee-id="employee.id"><i class="fa fa-external-link" role="img" aria-label='Redirect' title="Redirect"></i></a>
    </div>
</t>

</templates>
